(function($){$.fn.myAnalyticsLight=function(options){var defaults={php:"myAnalyticsLight/report.php",tooltip:true,tooltipOpacity:.8,dateFormat:"Y-m-d",data:[{metrics:"ga:pageviews",label:"Pageviews",color:"#0000FF"}]};var options=$.extend(defaults,options);return this.each(function(){obj=$(this);obj.html("Loading...");var dataStore;try{$.ajax({async:false,url:options.php,type:"POST",data:options,dataType:"json",success:function(a){dataStore=a},error:function(a){obj.html(a)},statusCode:{404:function(){obj.html("PHP file not found!")}}});if(dataStore.status!=200){obj.html(dataStore.message)}else{var valuesArray=[];var dates=[];var tooltipDates=[];var maxY=0;Array.max=function(a){return Math.max.apply(Math,a)};maxY=0;$.each(dataStore.data.values,function(a,b){if(maxY<Array.max(b)){maxY=Array.max(b)}});data=new Array;$.each(dataStore.data.values,function(a,b){valuesArray=Array();$.each(b,function(a,b){valuesArray.push([a,b])});data.push({data:valuesArray,label:options.data[a].label,color:options.data[a].color})});$.each(dataStore.data.dates,function(a,b){if(a%5==0){dates.push([a,b])}tooltipDates.push([a,b])});var plot=$.plot(obj,data,{series:{lines:{show:true},points:{show:true}},legend:{backgroundOpacity:.3},grid:{hoverable:true,clickable:true},yaxis:{min:0,max:maxY+maxY/2},xaxis:{ticks:dates}});function showTooltip(a,b,c){$('<div id="tooltip">'+c+"</div>").css({position:"absolute",display:"none",top:b+5,left:a+5,border:"1px solid #000",padding:"2px","font-size":"100%","background-color":"#FFF","-moz-border-radius":"4px","-webkit-border-radius":"4px","border-radius":"4px",opacity:options.tooltipOpacity}).appendTo("body").fadeIn(200)}if(options.tooltip){var previousPoint=null;obj.bind("plothover",function(event,pos,item){if(item){if(previousPoint!=item.datapoint){previousPoint=item.datapoint;$("#tooltip").remove();var x=item.datapoint[0].toFixed(2),y=item.datapoint[1].toFixed(2);x=Math.round(x);x=eval(x);x=tooltipDates[x][1];showTooltip(item.pageX,item.pageY,"<small>"+x+"</small><br />"+item.series.label+": <b>"+Math.round(y)+"</b>")}}else{$("#tooltip").remove();previousPoint=null}})}}}catch(err){obj.html("Something wrong with the script. <br />"+err.description)}})}})(jQuery)
